Source: https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls

[ Skip Navigation ](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#app-main)
  * [Global Nav Open Menu](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#ac-gn-menustate)[Global Nav Close Menu](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls)
  * [Apple Developer](https://developer.apple.com/)


[ Search Developer Cancel  ](https://developer.apple.com/search/)
  * [Apple Developer](https://developer.apple.com/)
  * [News](https://developer.apple.com/news/)
  * [Discover](https://developer.apple.com/discover/)
  * [Design](https://developer.apple.com/design/)
  * [Develop](https://developer.apple.com/develop/)
  * [Distribute](https://developer.apple.com/distribute/)
  * [Support](https://developer.apple.com/support/)
  * [Account](https://developer.apple.com/account/)
  * [](https://developer.apple.com/search/)


Cancel 
Only search within “Documentation”
### Quick Links
  * [Downloads](https://developer.apple.com/download/)
  * [Documentation](https://developer.apple.com/documentation/)
  * [Sample Code](https://developer.apple.com/documentation/samplecode/)
  * [Videos](https://developer.apple.com/videos/)
  * [Forums](https://developer.apple.com/forums/)

5 Quick Links
[ Documentation ](https://developer.apple.com/documentation)
[ Open Menu ](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls)
  * SwiftLanguage:  Swift  Objective-C 
Language: 
    * Swift 
    * [ Objective-C ](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls)


[](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls)
## [ Network  ](https://developer.apple.com/documentation/network)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
34 of 111 symbols inside <root> containing 4 symbols[Recording a Packet Trace](https://developer.apple.com/documentation/network/recording-a-packet-trace)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
16 of 111 symbols inside <root> containing 5 symbols[NWProtocolUDP](https://developer.apple.com/documentation/network/nwprotocoludp)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
17 of 111 symbols inside <root> containing 7 symbols[NWProtocolIP](https://developer.apple.com/documentation/network/nwprotocolip)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
18 of 111 symbols inside <root> containing 11 symbols[NWProtocolWebSocket](https://developer.apple.com/documentation/network/nwprotocolwebsocket)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
19 of 111 symbols inside <root> containing 9 symbols[NWProtocolFramer](https://developer.apple.com/documentation/network/nwprotocolframer)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
20 of 111 symbols inside <root>
Network Security and Privacy
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
21 of 111 symbols inside <root> containing 89 symbols[Security Options](https://developer.apple.com/documentation/network/security-options)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
22 of 111 symbols inside <root> containing 6 symbols[Privacy Management](https://developer.apple.com/documentation/network/privacy-management)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
23 of 111 symbols inside <root> [Creating an Identity for Local Network TLS](https://developer.apple.com/documentation/network/creating-an-identity-for-local-network-tls)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
24 of 111 symbols inside <root>
Paths and Interfaces
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
S
25 of 111 symbols inside <root> containing 24 symbols[NWPath](https://developer.apple.com/documentation/network/nwpath)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
26 of 111 symbols inside <root> containing 15 symbols[NWPathMonitor](https://developer.apple.com/documentation/network/nwpathmonitor)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
S
27 of 111 symbols inside <root> containing 7 symbols[NWInterface](https://developer.apple.com/documentation/network/nwinterface)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
28 of 111 symbols inside <root>
Errors
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
E
29 of 111 symbols inside <root> containing 8 symbols[NWError](https://developer.apple.com/documentation/network/nwerror)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
30 of 111 symbols inside <root>
Network Debugging
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
31 of 111 symbols inside <root> [Choosing a Network Debugging Tool](https://developer.apple.com/documentation/network/choosing-a-network-debugging-tool)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
32 of 111 symbols inside <root> [Debugging HTTP Server-Side Errors](https://developer.apple.com/documentation/network/debugging-http-server-side-errors)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
33 of 111 symbols inside <root> [Debugging HTTPS Problems with CFNetwork Diagnostic Logging](https://developer.apple.com/documentation/network/debugging-https-problems-with-cfnetwork-diagnostic-logging)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
34 of 111 symbols inside <root> containing 4 symbols[Recording a Packet Trace](https://developer.apple.com/documentation/network/recording-a-packet-trace)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
35 of 111 symbols inside <root> [Taking Advantage of Third-Party Network Debugging Tools](https://developer.apple.com/documentation/network/taking-advantage-of-third-party-network-debugging-tools)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
36 of 111 symbols inside <root> [Testing and Debugging L4S in Your App](https://developer.apple.com/documentation/network/testing-and-debugging-l4s-in-your-app)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
37 of 111 symbols inside <root>
C-Language Symbols
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
38 of 111 symbols inside <root> containing 58 symbols[C-Language Symbols](https://developer.apple.com/documentation/network/c-language-symbols)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
39 of 111 symbols inside <root>
Structures
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
S
40 of 111 symbols inside <root> containing 5 symbols[nw_interface_radio_type_t](https://developer.apple.com/documentation/network/nw_interface_radio_type_t)
111 items were found. Tab back to navigate through them. 
/ 
Navigator is ready 
  * [ Network ](https://developer.apple.com/documentation/network)
  * [ Creating an Identity for Local Network TLS ](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls)
  *     * Creating an Identity for Local Network TLS 


Article
# Creating an Identity for Local Network TLS
Learn how to create and use a digital identity in your application for local network TLS.
## [Overview](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#overview)
In the context of Transport Layer Security (TLS), a _digital identity_ is a cryptographic asset that contains a certificate and an associated private key for encrypting network traffic sent between a client and a server. Creating a digital identity for iOS or macOS is done so clients can communicate using TLS over the internet or a local network.
In this scenario, a server accepts client connections on a local network. While this article focuses on local network TLS, you can apply many of the concepts for other use cases. For example, setting up TLS with a certificate obtained from third-party Certificate Authority or configuring any system that needs to establish chain of trust to a root certificate.
### [Prepare the Environment](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#Prepare-the-Environment)
Imagine you’re building an app to handle orders in a restaurant. This app runs on a server device — like an iPad or Mac — located at the front desk. Out in the restaurant, customers create and send orders to the server to be processed by the server using iOS client devices. In this situation, the server uses a digital identity from a local certificate authority to provide TLS to the clients. The following article explains how to setup both the server and client devices for local network TLS.
To create an identity for local network TLS the first thing you need to do is create and manage a local Certificate Authority (CA). A CA is a trusted entity that issues certificates for use in cryptographic operations. In this case, the CA serves as the trusted source of truth to issue a certificate that is used in a digital identity for TLS. Without this trusted authority, clients won’t be able to verify the issuer of the certificate they are using.
After creating the CA, you need to issue a leaf certificate for the digital identity that is installed on the server. Next, you need to distribute the identity to the server. In the restaurant example, this is either the macOS or iOS device acting as the server. Lastly, you also need to distribute the root certificate to all of the iOS client devices in the restaurant network so that they can establish the chain of trust during the handshake process, and trust evaluation doesn’t need to be overridden.
An overview of how this would work can be described as follows:
  1. Create and manage your own certificate authority using the Keychain app on macOS.
  2. Distribute the identity to the server. On macOS, either create and use an identity on the same machine the server is running on, or securely distribute the PKCS#12 file to the device Keychain. On iOS, import the PKCS#12 file onto the server device. For example, you could load the PKCS#12 file onto a thumb drive and import it to the iOS server app and save it in the Keychain.
  3. On iOS client devices, install the root certificate onto the iOS device to form the chain of trust.


### [Distribute the Identity to the Server](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#Distribute-the-Identity-to-the-Server)
On iOS, the certificate authority owner is faced with the challenge of distributing the identity to the server. After transferring the identity on the server — either through thumb drive or through secure network transfer — save it to the Keychain. To save the identity in the iOS Keychain, use the following:
```
let password = <# A password from the Keychain #>
let options = [kSecImportExportPassphrase: password ] as NSDictionary
var rawItems: CFArray?
let status = SecPKCS12Import(data as CFData, // Data from imported Identity.
                             options as CFDictionary,
                             &rawItems)


guard status == errSecSuccess,
      let items = rawItems,
      let dictionaryItems = items as? Array<Dictionary<String, Any>> else {
    // handle error …
}


let secIdentity: SecIdentity = dictionaryItems[0][kSecImportItemIdentity as String] as! SecIdentity


// Notice that kSecClass as String: kSecClassIdentity isn't used here as this is inferred from kSecValueRef.
let identityAddition = [
    kSecValueRef: secIdentity,
    kSecAttrLabel: "ListenerIdentityLabel"
] as NSDictionary


let identityStatus = SecItemAdd(identityAddition as CFDictionary, nil)


guard identityStatus == errSecSuccess else {
    // handle error …
}
// Added identity successfully.

```

To retrieve the identity from the iOS Keychain, use the following:
```
func getSecIdentity() -> SecIdentity? {


    // On the query, use kSecClassIdentity to make sure a SecIdentity is extracted.
    let identityQuery = [
        kSecClass: kSecClassIdentity,
        kSecReturnRef: true,
        kSecAttrLabel: "ListenerIdentityLabel"
    ] as NSDictionary
    var identityItem: CFTypeRef?
    let getIdentityStatus = SecItemCopyMatching(identityQuery as CFDictionary, &identityItem)


    guard getIdentityStatus == errSecSuccess else {
        // handle error …
    }
    let secIdentity = identityItem as! SecIdentity
    return secIdentity
}

```

With the local identity accessible from the Keychain, set it to [`NWListener`](https://developer.apple.com/documentation/network/nwlistener) to serve connections using TLS 1.2+ with the following:
```
let tlsOptions = NWProtocolTLS.Options()
let tlsParams = NWParameters(tls: tlsOptions, tcp: .init())


if let secIdentity = getSecIdentity(),
   let identity = sec_identity_create(secIdentity) {
    sec_protocol_options_set_min_tls_protocol_version(
        tlsOptions.securityProtocolOptions, .TLSv12)
    sec_protocol_options_set_local_identity(
        tlsOptions.securityProtocolOptions, identity)
} 
let listener = try NWListener(using: tlsParams, on: 4433)

```

On macOS, the code is largely the same except if the `NWListener` is running on the same machine that set up the local certificate authority then the app’s code can reference the identity by loading a reference from the [`SecCertificate`](https://developer.apple.com/documentation/Security/SecCertificate) in the Keychain. To retrieve the identity from the Keychain on macOS, use the following:
```
func getSecIdentity() -> SecIdentity? {


    var identity: SecIdentity?
    let getquery = [kSecClass: kSecClassCertificate,
        kSecAttrLabel: "certificate_name_in_keychain",
        kSecReturnRef: true] as NSDictionary


    var item: CFTypeRef?
    let status = SecItemCopyMatching(getquery as CFDictionary, &item)
    guard status == errSecSuccess else {
        // handle error …
    }
    let certificate = item as! SecCertificate


    let identityStatus = SecIdentityCreateWithCertificate(nil, certificate, &identity)
    guard identityStatus == errSecSuccess else {
        // handle error …
    }
    return identity
}

```

After loading the identity on macOS, you can use the exact same `NWListener` code on iOS.
### [Configure the Client Devices](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#Configure-the-Client-Devices)
For clients that connect to the server, install the root certificate on the client device to avoid overriding trust evaluation. After installing the root certificate on the client device, the client connects to the server using a local network name. When connecting from the client side of the connection, use the following:
```
let tlsOptions = NWProtocolTLS.Options()
sec_protocol_options_set_min_tls_protocol_version(
    tlsOptions.securityProtocolOptions, 
    .TLSv12)


let tlsParams = NWParameters(tls: tlsOptions, tcp: .init())


let endpoint = NWEndpoint.hostPort(host: "listener-name.local", port: 4433)
let connection = NWConnection(to: endpoint, using: tlsParams)

```

Note
If the root certificate from the CA is installed on the device, you can use the code above without implementing [`sec_protocol_options_set_verify_block(_:_:_:)`](https://developer.apple.com/documentation/Security/sec_protocol_options_set_verify_block\(_:_:_:\)) to override trust evaluation.
If your client needs to connect over IP, instead of using a local network name, the server needs to use a leaf certificate that lists the IP in the “IP Address” field of the Subject Alternative Name. This also avoids having to override trust evaluation on the client and allows client connections to use the following:
```
let tlsOptions = NWProtocolTLS.Options()
sec_protocol_options_set_min_tls_protocol_version(
    tlsOptions.securityProtocolOptions, 
    .TLSv12)


let tlsParams = NWParameters(tls: tlsOptions, tcp: .init())


let endpoint = NWEndpoint.hostPort(host: "x.x.x.x", port: 4433)
let connection = NWConnection(to: endpoint, using: tlsParams)

```

Attempting to connect from a client to a server without the root certificate installed on the client iOS device results in application errors similar to the following:
```
// [BoringSSL] boringssl_context_error_print(1863) boringssl ctx 0x2813acbe0: 4348594328:error:1000007d:SSL routines:OPENSSL_internal:CERTIFICATE_VERIFY_FAILED
// [BoringSSL] boringssl_session_handshake_incomplete(164) [C1:1][0x1032186d0] SSL library error

```

Note
The same is true if either the IP Address or DNS Name in the Subject Alternative Name fields are missing in the leaf certificate.
To work around this on the client, use `sec_protocol_options_set_verify_block` to perform your own verification checks on the peer’s leaf certificate. This isn’t the recommended path, but could be done in extreme cases. In the following example, [`SecPolicyCreateBasicX509()`](https://developer.apple.com/documentation/Security/SecPolicyCreateBasicX509\(\)) checks against the certificate’s basic x509 policy:
```
sec_protocol_options_set_verify_block(tlsOptions.securityProtocolOptions, { (_, trust, completionHandler) in
    let secTrustRef = sec_trust_copy_ref(trust).takeRetainedValue() as SecTrust


    // Cannot do hostname here because of IP.
    let x509Policy = SecPolicyCreateBasicX509()
    SecTrustSetPolicies(secTrustRef, x509Policy)


    var error: CFError?
    if !SecTrustEvaluateWithError(secTrustRef, &error) {
        completionHandler(false)
    }
    // Perfom other certificate-based checks.  


    completionHandler(true)
}, .main)

```

From there the client can set up a handshake using TLS on a local network.
## [See Also](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#see-also)
### [Network Security and Privacy](https://developer.apple.com/documentation/Network/creating-an-identity-for-local-network-tls#Network-Security-and-Privacy)
[API Reference Security Options](https://developer.apple.com/documentation/network/security-options)
Configure security options for TLS handshakes.
[API Reference Privacy Management](https://developer.apple.com/documentation/network/privacy-management)
Configure parameters related to user privacy.
Current page is Creating an Identity for Local Network TLS 
[Apple](https://www.apple.com)
  1. [Developer](https://developer.apple.com/)
  2. [ Documentation ](https://developer.apple.com/documentation/)


###  Platforms 
Toggle Menu 
  * [iOS](https://developer.apple.com/ios/)
  * [iPadOS](https://developer.apple.com/ipados/)
  * [macOS](https://developer.apple.com/macos/)
  * [tvOS](https://developer.apple.com/tvos/)
  * [visionOS](https://developer.apple.com/visionos/)
  * [watchOS](https://developer.apple.com/watchos/)


###  Tools 
Toggle Menu 
  * [Swift](https://developer.apple.com/swift/)
  * [SwiftUI](https://developer.apple.com/swiftui/)
  * [Swift Playground](https://developer.apple.com/swift-playground/)
  * [TestFlight](https://developer.apple.com/testflight/)
  * [Xcode](https://developer.apple.com/xcode/)
  * [Xcode Cloud](https://developer.apple.com/xcode-cloud/)
  * [SF Symbols](https://developer.apple.com/sf-symbols/)


###  Topics & Technologies 
Toggle Menu 
  * [Accessibility](https://developer.apple.com/accessibility/)
  * [Accessories](https://developer.apple.com/accessories/)
  * [App Extension](https://developer.apple.com/app-extensions/)
  * [App Store](https://developer.apple.com/app-store/)
  * [Audio & Video](https://developer.apple.com/audio/)
  * [Augmented Reality](https://developer.apple.com/augmented-reality/)
  * [Design](https://developer.apple.com/design/)
  * [Distribution](https://developer.apple.com/distribute/)
  * [Education](https://developer.apple.com/education/)
  * [Fonts](https://developer.apple.com/fonts/)
  * [Games](https://developer.apple.com/games/)
  * [Health & Fitness](https://developer.apple.com/health-fitness/)
  * [In-App Purchase](https://developer.apple.com/in-app-purchase/)
  * [Localization](https://developer.apple.com/localization/)
  * [Maps & Location](https://developer.apple.com/maps/)
  * [Machine Learning & AI](https://developer.apple.com/machine-learning/)
  * [Open Source](https://opensource.apple.com/)
  * [Security](https://developer.apple.com/security/)
  * [Safari & Web](https://developer.apple.com/safari/)


###  Resources 
Toggle Menu 
  *   * [Documentation](https://developer.apple.com/documentation/)
  * [Tutorials](https://developer.apple.com/learn/)
  * [Downloads](https://developer.apple.com/download/)
  * [Forums](https://developer.apple.com/forums/)
  * [Videos](https://developer.apple.com/videos/)


###  Support 
Toggle Menu 
  * [Support Articles](https://developer.apple.com/support/articles/)
  * [Contact Us](https://developer.apple.com/contact/)
  * [Bug Reporting](https://developer.apple.com/bug-reporting/)
  * [System Status](https://developer.apple.com/system-status/)


###  Account 
Toggle Menu 
  * [Apple Developer](https://developer.apple.com/account/)
  * [App Store Connect](https://appstoreconnect.apple.com/)
  * [Certificates, IDs, & Profiles](https://developer.apple.com/account/ios/certificate/)
  * [Feedback Assistant](https://feedbackassistant.apple.com/)


###  Programs 
Toggle Menu 
  * [Apple Developer Program](https://developer.apple.com/programs/)
  * [Apple Developer Enterprise Program](https://developer.apple.com/programs/enterprise/)
  * [App Store Small Business Program](https://developer.apple.com/app-store/small-business-program/)
  * [MFi Program](https://mfi.apple.com/)
  * [News Partner Program](https://developer.apple.com/programs/news-partner/)
  * [Video Partner Program](https://developer.apple.com/programs/video-partner/)
  * [Security Bounty Program](https://developer.apple.com/security-bounty/)
  * [Security Research Device Program](https://developer.apple.com/programs/security-research-device/)


###  Events 
Toggle Menu 
  * [Meet with Apple](https://developer.apple.com/events/)
  * [Apple Developer Centers](https://developer.apple.com/events/developer-centers/)
  * [App Store Awards](https://developer.apple.com/app-store/app-store-awards/)
  * [Apple Design Awards](https://developer.apple.com/design/awards/)
  * [Apple Developer Academies](https://developer.apple.com/academies/)
  * [WWDC](https://developer.apple.com/wwdc/)


To submit feedback on documentation, visit [Feedback Assistant](applefeedback://new?form_identifier=developertools.fba&answers%5B%3Aarea%5D=seedADC%3Adevpubs&answers%5B%3Adoc_type_req%5D=Technology%20Documentation&answers%5B%3Adocumentation_link_req%5D=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2FNetwork%2Fcreating-an-identity-for-local-network-tls).
Select a color scheme preference
Light
Dark
Auto
Copyright © 2025 [Apple Inc.](https://www.apple.com) All rights reserved. 
[ Terms of Use ](https://www.apple.com/legal/internet-services/terms/site.html)[ Privacy Policy ](https://www.apple.com/legal/privacy/)[ Agreements and Guidelines ](https://developer.apple.com/support/terms/)
