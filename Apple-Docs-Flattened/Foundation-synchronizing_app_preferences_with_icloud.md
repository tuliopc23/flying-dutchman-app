Source: https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud

[ Skip Navigation ](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#app-main)
  * [Global Nav Open Menu](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#ac-gn-menustate)[Global Nav Close Menu](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud)
  * [Apple Developer](https://developer.apple.com/)


[ Search Developer Cancel  ](https://developer.apple.com/search/)
  * [Apple Developer](https://developer.apple.com/)
  * [News](https://developer.apple.com/news/)
  * [Discover](https://developer.apple.com/discover/)
  * [Design](https://developer.apple.com/design/)
  * [Develop](https://developer.apple.com/develop/)
  * [Distribute](https://developer.apple.com/distribute/)
  * [Support](https://developer.apple.com/support/)
  * [Account](https://developer.apple.com/account/)
  * [](https://developer.apple.com/search/)


Cancel 
Only search within “Documentation”
### Quick Links
  * [Downloads](https://developer.apple.com/download/)
  * [Documentation](https://developer.apple.com/documentation/)
  * [Sample Code](https://developer.apple.com/documentation/samplecode/)
  * [Videos](https://developer.apple.com/videos/)
  * [Forums](https://developer.apple.com/forums/)

5 Quick Links
[ Documentation ](https://developer.apple.com/documentation)
[ Open Menu ](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud)
  * SwiftLanguage:  Swift  Objective-C 
Language: 
    * Swift 
    * [ Objective-C ](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud)


[](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud)
## [ Foundation  ](https://developer.apple.com/documentation/foundation)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
T
11 of 17 symbols inside 883988861 [com.apple.developer.icloud-container-development-container-identifiers](https://developer.apple.com/documentation/bundleresources/entitlements/com.apple.developer.icloud-container-development-container-identifiers)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
14 of 64 symbols inside <root> containing 13 symbols[Errors and Exceptions](https://developer.apple.com/documentation/foundation/errors-and-exceptions)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
15 of 64 symbols inside <root> containing 45 symbols[Scripting Support](https://developer.apple.com/documentation/foundation/scripting-support)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
16 of 64 symbols inside <root>
Files and Data Persistence
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
17 of 64 symbols inside <root> containing 17 symbols[File System](https://developer.apple.com/documentation/foundation/file-system)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
18 of 64 symbols inside <root> containing 32 symbols[Archives and Serialization](https://developer.apple.com/documentation/foundation/archives-and-serialization)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
19 of 64 symbols inside <root> containing 8 symbols[Settings](https://developer.apple.com/documentation/foundation/settings)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
20 of 64 symbols inside <root> containing 5 symbols[Spotlight](https://developer.apple.com/documentation/foundation/spotlight)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
21 of 64 symbols inside <root> containing 17 symbols[iCloud](https://developer.apple.com/documentation/foundation/icloud)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
1 of 17 symbols inside 883988861 
iCloud Storage
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
2 of 17 symbols inside 883988861 containing 136 symbols[FileManager](https://developer.apple.com/documentation/foundation/filemanager)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
rP
3 of 17 symbols inside 883988861 containing 20 symbols[FileManagerDelegate](https://developer.apple.com/documentation/foundation/filemanagerdelegate)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
4 of 17 symbols inside 883988861 
App Preferences
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
5 of 17 symbols inside 883988861 containing 33 symbols[NSUbiquitousKeyValueStore](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestore)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
6 of 17 symbols inside 883988861 
File Search
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
7 of 17 symbols inside 883988861 containing 42 symbols[NSMetadataQuery](https://developer.apple.com/documentation/foundation/nsmetadataquery)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
rP
8 of 17 symbols inside 883988861 containing 3 symbols[NSMetadataQueryDelegate](https://developer.apple.com/documentation/foundation/nsmetadataquerydelegate)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
C
9 of 17 symbols inside 883988861 containing 192 symbols[NSMetadataItem](https://developer.apple.com/documentation/foundation/nsmetadataitem)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
10 of 17 symbols inside 883988861 
Entitlements
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
T
11 of 17 symbols inside 883988861 [com.apple.developer.icloud-container-development-container-identifiers](https://developer.apple.com/documentation/bundleresources/entitlements/com.apple.developer.icloud-container-development-container-identifiers)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
T
12 of 17 symbols inside 883988861 [com.apple.developer.icloud-container-environment](https://developer.apple.com/documentation/bundleresources/entitlements/com.apple.developer.icloud-container-environment)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
T
13 of 17 symbols inside 883988861 [iCloud Container Identifiers Entitlement](https://developer.apple.com/documentation/bundleresources/entitlements/com.apple.developer.icloud-container-identifiers)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
T
14 of 17 symbols inside 883988861 [iCloud Services Entitlement](https://developer.apple.com/documentation/bundleresources/entitlements/com.apple.developer.icloud-services)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
T
15 of 17 symbols inside 883988861 [iCloud Key-Value Store Entitlement](https://developer.apple.com/documentation/bundleresources/entitlements/com.apple.developer.ubiquity-kvstore-identifier)
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
16 of 17 symbols inside 883988861 
Errors
To navigate the symbols, press Up Arrow, Down Arrow, Left Arrow or Right Arrow 
Collection
17 of 17 symbols inside 883988861 containing 15 symbols[iCloud Error Codes](https://developer.apple.com/documentation/foundation/icloud-error-codes)
81 items were found. Tab back to navigate through them. 
/ 
Navigator is ready 
  * [ Foundation ](https://developer.apple.com/documentation/foundation)
  * [ iCloud ](https://developer.apple.com/documentation/foundation/icloud)
  * [ Synchronizing App Preferences with iCloud ](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud)
  *     * [ iCloud ](https://developer.apple.com/documentation/foundation/icloud)
    * Synchronizing App Preferences with iCloud 


Sample Code
# Synchronizing App Preferences with iCloud
Store app preferences in iCloud and share them among instances of your app running on a user’s connected devices.
[ Download ](https://docs-assets.developer.apple.com/published/400e91e74e/SynchronizingAppPreferencesWithICloud.zip)
iOS 13.5+iPadOS 13.5+macOS 10.13+Xcode 11.6+
## [Overview](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#overview)
This sample demonstrates how to store preference, configuration, and app-state data in the iCloud key-value store using the [`NSUbiquitousKeyValueStore`](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestore) class. You can then share this data with every instance of your app on every device connected to a userʼs iCloud account.
In this sample the user picks a background color. App instances running on other devices that are logged in with the same iCloud account are then notified of the color to match.
Note
With `NSUbiquitousKeyValueStore` you’re limited to 1 MB of total space. Don’t use it to store large amounts of data.
The key-value store is not a replacement for [`UserDefaults`](https://developer.apple.com/documentation/foundation/userdefaults) or other local techniques for saving the same data. The key-value store’s purpose is to synchronize key-value data between app instances running on different devices of the same user. If iCloud is not enabled or is not available on a given device, the app still keeps a local copy of the data in `NSUserDefaults`.
### [Configure the Sample Code Project](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#3678696)
To configure your Xcode project first you need change the Bundle Identifiers for both macOS and iOS targets to match your own. Next, to work with iCloud and `NSUbiquitousKeyValueStore`, you need set up an iCloud key-value store ID for both targets. This sample already has the both targets’ iCloud capabilities set up, with the `PrefsInCloud.entitlements` file already created. You need to fill in your own key-value store IDs in those entitlement files to complete the configurations.
For each target (iOS and macOS):
  1. In the Xcode project, open the target’s `PrefsInCloud.entitlements` file.
  2. In that file, go to `com.apple.developer.ubiquity-kvstore-identifier` entitlement and replace `$(CFBundleIdenfier)` with your key-value store ID (i.e. `$(TeamIdentifierPrefix)<your key-value_store ID>`). For example if your key-value store ID is “com.mycompany.myKeyValueStoreID” it would look like this: `$(TeamIdentifierPrefix)com.mycompany.myKeyValueStoreID`. It’s important that the key-value store ID portions are the same between both targets.


In addition to configuring the project, you need to configure the devices in which the project runs.
To configure the iOS and macOS devices, verify that iCloud Drive is turned on. Then log into both devices with the same iCloud account.
Build and run the app to install it on both devices, and then do the following:
  * iOS: Tap the action button at the top right to pick the desired background color.
  * macOS: Choose the desired background color from window’s popup menu.


The desired color represents a value (numbered 0 to 3) which is uploaded to iCloud. App instances running on the other devices logged into the same iCloud account are notified to match that specific background color.
Important
The key-value store is intended for storing data that changes infrequently. As you test your devices, if the app on a device makes frequent changes to the key-value store, the system may defer the synchronization of some changes in order to minimize the number of round trips to the server. The more frequently the app make changes, the more likely the changes will be deferred and will not immediately show up on the other devices.
### [Register to Respond to Key-Value Store Changes](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#3678697)
The sample uses [`NotificationCenter`](https://developer.apple.com/documentation/foundation/notificationcenter) to register as an observer to the notification [`didChangeExternallyNotification`](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestore/didchangeexternallynotification). The following example installs the app as the observer to respond to the key-value store changes:
```
NotificationCenter.default.addObserver(self,
    selector: #selector(ubiquitousKeyValueStoreDidChange(_:)),
    name: NSUbiquitousKeyValueStore.didChangeExternallyNotification,
    object: NSUbiquitousKeyValueStore.default)

```

Immediately following the call to `addObserver`, obtain the key-value store changes since last launch by calling `synchronize()`. The operating system controls when keys and values are uploaded to iCloud. Calling `synchronize()` simply stores a local cache of them and notifies iCloud of new data waiting to be uploaded.
### [Respond to Key-Value Store Changes](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#3678698)
The sample uses `NSNotificationCenter` to register as an observer to the notification [`didChangeExternallyNotification`](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestore/didchangeexternallynotification) to detect for value changes in iCloud.
The sample implements the function `ubiquitousKeyValueStoreDidChange` for listening for key-value notification changes. This function is called when the key-value store in the cloud has changed externally. It replaces the old key-value color with the new one. Additionally, this function updates the `NSUserDefaults` key-value.
This sample examines the reason for the change through the use the [`NSUbiquitousKeyValueStoreChangeReasonKey`](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestorechangereasonkey) from the notification’s `userInfo`.
```
guard let userInfo = notification.userInfo else { return }
      
// Get the reason for the notification (initial download, external change or quota violation change).
guard let reasonForChange = userInfo[NSUbiquitousKeyValueStoreChangeReasonKey] as? Int else { return }

```

The reason for the key-value notification change is one of the following:
  * `NSUbiquitousKeyValueStoreServerChange`: Value(s) were changed externally from other users/devices.
  * `NSUbiquitousKeyValueStoreInitialSyncChange`: Initial downloads happen the first time a device is connected to an iCloud account, and when a user switches their primary iCloud account.
  * `NSUbiquitousKeyValueStoreQuotaViolationChange`: The app’s key-value store has exceeded its space quota on the iCloud server.
  * `NSUbiquitousKeyValueStoreAccountChange`: The user has changed the primary iCloud account.


To obtain key-values that have changed, use the key [`NSUbiquitousKeyValueStoreChangedKeysKey`](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestorechangedkeyskey) from the notification’s `userInfo`.
```
guard let keys =
          userInfo[NSUbiquitousKeyValueStoreChangedKeysKey] as? [String] else { return }

```

```
let possibleColorIndexFromiCloud =
          NSUbiquitousKeyValueStore.default.longLong(forKey: gBackgroundColorKey)

```

## [See Also](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#see-also)
### [App Preferences](https://developer.apple.com/documentation/foundation/icloud/synchronizing_app_preferences_with_icloud#app-preferences)
[`class NSUbiquitousKeyValueStore`](https://developer.apple.com/documentation/foundation/nsubiquitouskeyvaluestore)
An iCloud-based container of key-value pairs you use to share data among instances of your app running on a user’s connected devices.
Current page is Synchronizing App Preferences with iCloud 
[Apple](https://www.apple.com)
  1. [Developer](https://developer.apple.com/)
  2. [ Documentation ](https://developer.apple.com/documentation/)


###  Platforms 
Toggle Menu 
  * [iOS](https://developer.apple.com/ios/)
  * [iPadOS](https://developer.apple.com/ipados/)
  * [macOS](https://developer.apple.com/macos/)
  * [tvOS](https://developer.apple.com/tvos/)
  * [visionOS](https://developer.apple.com/visionos/)
  * [watchOS](https://developer.apple.com/watchos/)


###  Tools 
Toggle Menu 
  * [Swift](https://developer.apple.com/swift/)
  * [SwiftUI](https://developer.apple.com/swiftui/)
  * [Swift Playground](https://developer.apple.com/swift-playground/)
  * [TestFlight](https://developer.apple.com/testflight/)
  * [Xcode](https://developer.apple.com/xcode/)
  * [Xcode Cloud](https://developer.apple.com/xcode-cloud/)
  * [SF Symbols](https://developer.apple.com/sf-symbols/)


###  Topics & Technologies 
Toggle Menu 
  * [Accessibility](https://developer.apple.com/accessibility/)
  * [Accessories](https://developer.apple.com/accessories/)
  * [App Extension](https://developer.apple.com/app-extensions/)
  * [App Store](https://developer.apple.com/app-store/)
  * [Audio & Video](https://developer.apple.com/audio/)
  * [Augmented Reality](https://developer.apple.com/augmented-reality/)
  * [Design](https://developer.apple.com/design/)
  * [Distribution](https://developer.apple.com/distribute/)
  * [Education](https://developer.apple.com/education/)
  * [Fonts](https://developer.apple.com/fonts/)
  * [Games](https://developer.apple.com/games/)
  * [Health & Fitness](https://developer.apple.com/health-fitness/)
  * [In-App Purchase](https://developer.apple.com/in-app-purchase/)
  * [Localization](https://developer.apple.com/localization/)
  * [Maps & Location](https://developer.apple.com/maps/)
  * [Machine Learning & AI](https://developer.apple.com/machine-learning/)
  * [Open Source](https://opensource.apple.com/)
  * [Security](https://developer.apple.com/security/)
  * [Safari & Web](https://developer.apple.com/safari/)


###  Resources 
Toggle Menu 
  *   * [Documentation](https://developer.apple.com/documentation/)
  * [Tutorials](https://developer.apple.com/learn/)
  * [Downloads](https://developer.apple.com/download/)
  * [Forums](https://developer.apple.com/forums/)
  * [Videos](https://developer.apple.com/videos/)


###  Support 
Toggle Menu 
  * [Support Articles](https://developer.apple.com/support/articles/)
  * [Contact Us](https://developer.apple.com/contact/)
  * [Bug Reporting](https://developer.apple.com/bug-reporting/)
  * [System Status](https://developer.apple.com/system-status/)


###  Account 
Toggle Menu 
  * [Apple Developer](https://developer.apple.com/account/)
  * [App Store Connect](https://appstoreconnect.apple.com/)
  * [Certificates, IDs, & Profiles](https://developer.apple.com/account/ios/certificate/)
  * [Feedback Assistant](https://feedbackassistant.apple.com/)


###  Programs 
Toggle Menu 
  * [Apple Developer Program](https://developer.apple.com/programs/)
  * [Apple Developer Enterprise Program](https://developer.apple.com/programs/enterprise/)
  * [App Store Small Business Program](https://developer.apple.com/app-store/small-business-program/)
  * [MFi Program](https://mfi.apple.com/)
  * [News Partner Program](https://developer.apple.com/programs/news-partner/)
  * [Video Partner Program](https://developer.apple.com/programs/video-partner/)
  * [Security Bounty Program](https://developer.apple.com/security-bounty/)
  * [Security Research Device Program](https://developer.apple.com/programs/security-research-device/)


###  Events 
Toggle Menu 
  * [Meet with Apple](https://developer.apple.com/events/)
  * [Apple Developer Centers](https://developer.apple.com/events/developer-centers/)
  * [App Store Awards](https://developer.apple.com/app-store/app-store-awards/)
  * [Apple Design Awards](https://developer.apple.com/design/awards/)
  * [Apple Developer Academies](https://developer.apple.com/academies/)
  * [WWDC](https://developer.apple.com/wwdc/)


To submit feedback on documentation, visit [Feedback Assistant](applefeedback://new?form_identifier=developertools.fba&answers%5B%3Aarea%5D=seedADC%3Adevpubs&answers%5B%3Adoc_type_req%5D=Technology%20Documentation&answers%5B%3Adocumentation_link_req%5D=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ffoundation%2Ficloud%2Fsynchronizing_app_preferences_with_icloud).
Select a color scheme preference
Light
Dark
Auto
Copyright © 2025 [Apple Inc.](https://www.apple.com) All rights reserved. 
[ Terms of Use ](https://www.apple.com/legal/internet-services/terms/site.html)[ Privacy Policy ](https://www.apple.com/legal/privacy/)[ Agreements and Guidelines ](https://developer.apple.com/support/terms/)
